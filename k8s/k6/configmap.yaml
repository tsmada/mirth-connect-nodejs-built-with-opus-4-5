apiVersion: v1
kind: ConfigMap
metadata:
  name: k6-scripts
  namespace: mirth-k6
data:
  api-load.js: |
    import http from 'k6/http';
    import { check, sleep } from 'k6';
    import { Rate, Trend } from 'k6/metrics';

    const errorRate = new Rate('errors');
    const healthLatency = new Trend('health_latency');

    // Target the Node.js Mirth service in the cluster namespace
    const BASE_URL = __ENV.MIRTH_URL || 'http://node-mirth.mirth-cluster.svc.cluster.local:8080';

    export const options = {
      stages: [
        { duration: '30s', target: 10 },   // Ramp to 10 VUs
        { duration: '60s', target: 10 },   // Hold at 10
        { duration: '30s', target: 50 },   // Ramp to 50 VUs
        { duration: '60s', target: 50 },   // Hold at 50
        { duration: '30s', target: 0 },    // Ramp down
      ],
      thresholds: {
        'http_req_duration': ['p(95)<500'],
        'errors': ['rate<0.01'],
      },
    };

    export default function () {
      // Health check (most lightweight)
      const healthRes = http.get(`${BASE_URL}/api/health`);
      check(healthRes, {
        'health status 200': (r) => r.status === 200,
        'health has serverId': (r) => JSON.parse(r.body).serverId !== undefined,
      });
      healthLatency.add(healthRes.timings.duration);
      errorRate.add(healthRes.status !== 200);

      sleep(0.1);

      // Login and get session
      const loginRes = http.post(
        `${BASE_URL}/api/users/_login?username=admin`,
        'admin',
        {
          headers: {
            'Content-Type': 'text/plain',
            'X-Requested-With': 'XMLHttpRequest',
          },
        }
      );

      if (loginRes.status === 200) {
        const sessionId = loginRes.headers['X-Session-Id'] || loginRes.headers['x-session-id'];

        if (sessionId) {
          // Get channels
          const channelsRes = http.get(`${BASE_URL}/api/channels`, {
            headers: { 'X-Session-ID': sessionId },
          });
          check(channelsRes, {
            'channels status 200': (r) => r.status === 200,
          });
          errorRate.add(channelsRes.status !== 200);
        }
      }

      sleep(0.5);
    }
  mllp-load.js: |
    import http from 'k6/http';
    import { check, sleep } from 'k6';
    import { Rate, Counter } from 'k6/metrics';

    const errorRate = new Rate('errors');
    const messagesProcessed = new Counter('messages_processed');

    const BASE_URL = __ENV.MIRTH_URL || 'http://node-mirth.mirth-cluster.svc.cluster.local';

    // Sample HL7 ADT A01 message
    const HL7_MESSAGE = [
      'MSH|^~\\&|SENDING|FACILITY|RECEIVING|FACILITY|20260215120000||ADT^A01|MSG00001|P|2.3|',
      'EVN|A01|20260215120000||',
      'PID|||12345^^^MRN||DOE^JOHN^||19800101|M|||123 MAIN ST^^ANYTOWN^ST^12345||555-1234|||S|||999-99-9999',
      'PV1||I|ICU^0001^01||||1234^SMITH^JOHN^^^DR|||SUR||||ADM|A0|',
    ].join('\r');

    export const options = {
      stages: [
        { duration: '30s', target: 5 },
        { duration: '60s', target: 10 },
        { duration: '30s', target: 20 },
        { duration: '60s', target: 20 },
        { duration: '30s', target: 0 },
      ],
      thresholds: {
        'http_req_duration': ['p(95)<1000'],
        'errors': ['rate<0.05'],
      },
    };

    export default function () {
      // Send HL7 message to HTTP Gateway (port 8090)
      const res = http.post(`${BASE_URL}:8090`, HL7_MESSAGE, {
        headers: { 'Content-Type': 'text/plain' },
      });

      const success = check(res, {
        'message accepted': (r) => r.status === 200 || r.status === 201,
      });

      if (success) {
        messagesProcessed.add(1);
      }
      errorRate.add(!success);

      sleep(0.2);
    }
  shadow-cutover.js: |
    import http from 'k6/http';
    import { check, sleep } from 'k6';
    import { Rate } from 'k6/metrics';

    const BASE_URL = __ENV.MIRTH_URL || 'http://node-mirth.mirth-shadow.svc.cluster.local:8080';

    const shadowBlocked = new Rate('shadow_blocked');
    const afterCutover = new Rate('after_cutover');

    export const options = {
      duration: '3m',
      vus: 5,
    };

    export default function () {
      // Check health — should always succeed even in shadow mode
      const healthRes = http.get(`${BASE_URL}/api/health`);
      check(healthRes, {
        'health returns 200': (r) => r.status === 200,
      });

      // Try to get shadow status
      const loginRes = http.post(
        `${BASE_URL}/api/users/_login?username=admin`,
        'admin',
        {
          headers: {
            'Content-Type': 'text/plain',
            'X-Requested-With': 'XMLHttpRequest',
          },
        }
      );

      if (loginRes.status === 200) {
        const sessionId = loginRes.headers['X-Session-Id'] || loginRes.headers['x-session-id'];

        if (sessionId) {
          const shadowRes = http.get(`${BASE_URL}/api/system/shadow`, {
            headers: { 'X-Session-ID': sessionId },
          });

          check(shadowRes, {
            'shadow status accessible': (r) => r.status === 200,
          });

          // Try a write operation — should be blocked (409) in shadow mode
          const writeRes = http.post(`${BASE_URL}/api/channels`, '<channel/>', {
            headers: {
              'Content-Type': 'application/xml',
              'X-Session-ID': sessionId,
            },
          });

          if (writeRes.status === 409) {
            shadowBlocked.add(1);
          } else {
            afterCutover.add(1);
          }
        }
      }

      sleep(1);
    }
  benchmark-api.js: |
    import http from 'k6/http';
    import { check, sleep, group } from 'k6';
    import { Rate, Trend, Counter } from 'k6/metrics';

    // ── Metrics (engine-tagged) ──────────────────────────
    const healthLatency   = new Trend('health_latency',   true);
    const loginLatency    = new Trend('login_latency',    true);
    const channelLatency  = new Trend('channel_latency',  true);
    const statusLatency   = new Trend('status_latency',   true);
    const errorRate       = new Rate('error_rate');
    const requestCount    = new Counter('total_requests');

    // ── Endpoints ────────────────────────────────────────
    const JAVA_API   = __ENV.JAVA_API_URL   || 'https://java-mirth.mirth-infra.svc.cluster.local:8443';
    const NODEJS_API = __ENV.NODEJS_API_URL || 'http://node-mirth.mirth-benchmark.svc.cluster.local:8080';

    export const options = {
      insecureSkipTLSVerify: true,
      summaryTrendStats: ['avg', 'min', 'med', 'max', 'p(90)', 'p(95)', 'p(99)'],
      scenarios: {
        java_api: {
          executor: 'ramping-vus',
          startVUs: 0,
          stages: [
            { duration: '30s', target: 5 },   // warmup
            { duration: '60s', target: 10 },  // steady
            { duration: '60s', target: 25 },  // peak
            { duration: '10s', target: 0 },   // ramp down
          ],
          startTime: '0s',
          tags: { engine: 'java' },
          env: { TARGET_URL: JAVA_API, ENGINE: 'java' },
        },
        nodejs_api: {
          executor: 'ramping-vus',
          startVUs: 0,
          stages: [
            { duration: '30s', target: 5 },
            { duration: '60s', target: 10 },
            { duration: '60s', target: 25 },
            { duration: '10s', target: 0 },
          ],
          startTime: '170s',  // 160s for java + 10s gap
          tags: { engine: 'nodejs' },
          env: { TARGET_URL: NODEJS_API, ENGINE: 'nodejs' },
        },
      },
      thresholds: {
        'health_latency{engine:nodejs}':  ['p(95)<200'],
        'health_latency{engine:java}':    ['p(95)<500'],
        'login_latency{engine:nodejs}':   ['p(95)<300'],
        'login_latency{engine:java}':     ['p(95)<800'],
        'channel_latency{engine:nodejs}': ['p(95)<300'],
        'channel_latency{engine:java}':   ['p(95)<800'],
        'status_latency{engine:nodejs}':  ['p(95)<500'],
        'status_latency{engine:java}':    ['p(95)<1000'],
        'total_requests{engine:nodejs}':  ['count>=0'],
        'total_requests{engine:java}':    ['count>=0'],
        'error_rate{engine:nodejs}':      ['rate<0.05'],
        'error_rate{engine:java}':        ['rate<0.05'],
        'error_rate':                     ['rate<0.05'],
      },
    };

    export default function () {
      const targetUrl = __ENV.TARGET_URL;
      const engine    = __ENV.ENGINE;
      const isJava    = engine === 'java';
      const tags      = { engine };
      const tlsOpts   = isJava ? { insecureSkipTLSVerify: true } : {};

      // ── Health Check ─────────────────────────────────
      group('health', function () {
        const healthPath = isJava ? '/api/server/version' : '/api/health';
        const res = http.get(`${targetUrl}${healthPath}`, Object.assign({ tags }, tlsOpts));
        check(res, { 'health 200': (r) => r.status === 200 });
        healthLatency.add(res.timings.duration, tags);
        errorRate.add(res.status !== 200, tags);
        requestCount.add(1, tags);
      });

      sleep(0.1);

      // ── Login ────────────────────────────────────────
      // Java Mirth: form-urlencoded + JSESSIONID cookie
      // Node.js Mirth: JSON body + X-Session-ID header
      let authHeaders = {};
      let loginOk = false;
      group('login', function () {
        let res;
        if (isJava) {
          res = http.post(
            `${targetUrl}/api/users/_login`,
            'username=admin&password=admin',
            Object.assign({
              headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-Requested-With': 'XMLHttpRequest',
              },
              tags,
            }, tlsOpts)
          );
          // k6 automatically handles Set-Cookie → cookie jar for subsequent requests
          authHeaders = {};
        } else {
          res = http.post(
            `${targetUrl}/api/users/_login`,
            JSON.stringify({ username: 'admin', password: 'admin' }),
            Object.assign({
              headers: {
                'Content-Type': 'application/json',
              },
              tags,
            }, tlsOpts)
          );
          const sid = res.headers['X-Session-Id'] || res.headers['x-session-id'];
          if (sid) {
            authHeaders = { 'X-Session-ID': sid };
          }
        }
        check(res, { 'login 200': (r) => r.status === 200 });
        loginLatency.add(res.timings.duration, tags);
        errorRate.add(res.status !== 200, tags);
        requestCount.add(1, tags);
        loginOk = res.status === 200;
      });

      if (!loginOk) {
        sleep(0.5);
        return;
      }

      sleep(0.1);

      // ── Channel List ─────────────────────────────────
      group('channels', function () {
        const res = http.get(`${targetUrl}/api/channels`, Object.assign({
          headers: authHeaders,
          tags,
        }, tlsOpts));
        check(res, { 'channels 200': (r) => r.status === 200 });
        channelLatency.add(res.timings.duration, tags);
        errorRate.add(res.status !== 200, tags);
        requestCount.add(1, tags);
      });

      sleep(0.1);

      // ── Channel Statuses ─────────────────────────────
      group('statuses', function () {
        const res = http.get(`${targetUrl}/api/channels/statuses`, Object.assign({
          headers: authHeaders,
          tags,
        }, tlsOpts));
        check(res, { 'statuses 200': (r) => r.status === 200 || r.status === 204 });
        statusLatency.add(res.timings.duration, tags);
        errorRate.add(res.status !== 200 && res.status !== 204, tags);
        requestCount.add(1, tags);
      });

      sleep(0.3);
    }

    // Helper: safely format a metric value
    function fmt(val, decimals) {
      if (val === undefined || val === null) return 'N/A';
      return typeof val === 'number' ? val.toFixed(decimals || 0) : String(val);
    }

    export function handleSummary(data) {
      const lines = [];
      lines.push('');
      lines.push('========================================');
      lines.push('  BENCHMARK: REST API COMPARISON');
      lines.push('========================================');
      lines.push('');
      lines.push('  Both engines running natively on ARM64.');
      lines.push('  Java: Temurin JDK 11 | Node.js: v20 Alpine');
      lines.push('');

      const metrics = ['health_latency', 'login_latency', 'channel_latency', 'status_latency'];
      for (const m of metrics) {
        lines.push(`  ${m}:`);
        for (const eng of ['java', 'nodejs']) {
          const key = `${m}{engine:${eng}}`;
          const vals = data.metrics[key];
          if (vals && vals.values) {
            const v = vals.values;
            lines.push(`    engine=${eng}:   p50=${fmt(v.med)}ms  p95=${fmt(v['p(95)'])}ms  p99=${fmt(v['p(99)'])}ms  avg=${fmt(v.avg)}ms`);
          } else {
            lines.push(`    engine=${eng}:   (no data)`);
          }
        }
        lines.push('');
      }

      // Total requests per engine
      for (const eng of ['java', 'nodejs']) {
        const key = `total_requests{engine:${eng}}`;
        const vals = data.metrics[key];
        if (vals && vals.values) {
          lines.push(`  total_requests (${eng}): ${vals.values.count}`);
        }
      }

      // Error rates
      for (const eng of ['java', 'nodejs']) {
        const key = `error_rate{engine:${eng}}`;
        const vals = data.metrics[key];
        if (vals && vals.values) {
          lines.push(`  error_rate (${eng}): ${fmt(vals.values.rate * 100, 2)}%`);
        }
      }

      lines.push('');
      lines.push('========================================');
      const summary = lines.join('\n');
      return {
        stdout: summary + '\n',
      };
    }
  benchmark-hl7.js: |
    import http from 'k6/http';
    import { check, sleep, group } from 'k6';
    import { Rate, Trend, Counter } from 'k6/metrics';

    const hl7Latency    = new Trend('hl7_latency',    true);
    const hl7Throughput = new Counter('hl7_processed', true);
    const errorRate     = new Rate('hl7_error_rate');

    const JAVA_MSG_URL   = __ENV.JAVA_MSG_URL   || 'http://java-mirth.mirth-infra.svc.cluster.local';
    const NODEJS_MSG_URL = __ENV.NODEJS_MSG_URL || 'http://node-mirth.mirth-benchmark.svc.cluster.local';

    // Sample HL7 ADT A01 message
    const HL7_MESSAGE = [
      'MSH|^~\\&|BENCHMARK|FACILITY|RECEIVING|FACILITY|20260215120000||ADT^A01|MSG${__VU}${__ITER}|P|2.3|',
      'EVN|A01|20260215120000||',
      'PID|||12345^^^MRN||DOE^JOHN^||19800101|M|||123 MAIN ST^^ANYTOWN^ST^12345||555-1234|||S|||999-99-9999',
      'PV1||I|ICU^0001^01||||1234^SMITH^JOHN^^^DR|||SUR||||ADM|A0|',
    ].join('\r');

    export const options = {
      summaryTrendStats: ['avg', 'min', 'med', 'max', 'p(90)', 'p(95)', 'p(99)'],
      scenarios: {
        java_hl7: {
          executor: 'ramping-vus',
          startVUs: 0,
          stages: [
            { duration: '20s', target: 3 },   // warmup
            { duration: '60s', target: 10 },  // load
            { duration: '10s', target: 0 },   // ramp down
          ],
          startTime: '0s',
          tags: { engine: 'java' },
          env: { TARGET_URL: `${JAVA_MSG_URL}:7092`, ENGINE: 'java' },
        },
        nodejs_hl7: {
          executor: 'ramping-vus',
          startVUs: 0,
          stages: [
            { duration: '20s', target: 3 },
            { duration: '60s', target: 10 },
            { duration: '10s', target: 0 },
          ],
          startTime: '100s',  // 90s for java + 10s gap
          tags: { engine: 'nodejs' },
          env: { TARGET_URL: `${NODEJS_MSG_URL}:7082`, ENGINE: 'nodejs' },
        },
      },
      thresholds: {
        'hl7_latency{engine:nodejs}':  ['p(95)<500'],
        'hl7_latency{engine:java}':    ['p(95)<1000'],
        'hl7_processed{engine:nodejs}': ['count>=0'],
        'hl7_processed{engine:java}':   ['count>=0'],
        'hl7_error_rate{engine:nodejs}': ['rate<0.1'],
        'hl7_error_rate{engine:java}':   ['rate<0.1'],
        'hl7_error_rate':              ['rate<0.1'],
      },
    };

    export default function () {
      const targetUrl = __ENV.TARGET_URL;
      const engine    = __ENV.ENGINE;
      const tags      = { engine };

      // Generate unique message ID per iteration
      const msgId = `MSG${__VU}-${__ITER}-${Date.now()}`;
      const message = HL7_MESSAGE.replace('MSG${__VU}${__ITER}', msgId);

      const res = http.post(`${targetUrl}/bench-hl7/`, message, {
        headers: { 'Content-Type': 'text/plain' },
        tags,
      });

      const ok = check(res, {
        'hl7 accepted': (r) => r.status === 200 || r.status === 201,
      });

      hl7Latency.add(res.timings.duration, tags);
      if (ok) {
        hl7Throughput.add(1, tags);
      }
      errorRate.add(!ok, tags);

      sleep(0.1);
    }

    // Helper: safely format a metric value
    function fmt(val, decimals) {
      if (val === undefined || val === null) return 'N/A';
      return typeof val === 'number' ? val.toFixed(decimals || 0) : String(val);
    }

    export function handleSummary(data) {
      const lines = [];
      lines.push('');
      lines.push('========================================');
      lines.push('  BENCHMARK: HL7 MESSAGE PROCESSING');
      lines.push('========================================');
      lines.push('');
      lines.push('  Both engines running natively on ARM64.');
      lines.push('  Java: Temurin JDK 11 | Node.js: v20 Alpine');
      lines.push('');

      lines.push('  hl7_latency:');
      for (const eng of ['java', 'nodejs']) {
        const key = `hl7_latency{engine:${eng}}`;
        const vals = data.metrics[key];
        if (vals && vals.values) {
          const v = vals.values;
          lines.push(`    engine=${eng}:   p50=${fmt(v.med)}ms  p95=${fmt(v['p(95)'])}ms  p99=${fmt(v['p(99)'])}ms  avg=${fmt(v.avg)}ms`);
        } else {
          lines.push(`    engine=${eng}:   (no data)`);
        }
      }

      lines.push('');
      for (const eng of ['java', 'nodejs']) {
        const key = `hl7_processed{engine:${eng}}`;
        const vals = data.metrics[key];
        if (vals && vals.values) {
          lines.push(`  total_messages (${eng}): ${vals.values.count}`);
        }
      }

      lines.push('');
      for (const eng of ['java', 'nodejs']) {
        const key = `hl7_error_rate{engine:${eng}}`;
        const vals = data.metrics[key];
        if (vals && vals.values) {
          lines.push(`  error_rate (${eng}): ${fmt(vals.values.rate * 100, 2)}%`);
        }
      }

      lines.push('');
      lines.push('========================================');
      return { stdout: lines.join('\n') + '\n' };
    }
  benchmark-json.js: |
    import http from 'k6/http';
    import { check, sleep } from 'k6';
    import { Rate, Trend, Counter } from 'k6/metrics';

    const jsonLatency    = new Trend('json_latency',    true);
    const jsonThroughput = new Counter('json_processed', true);
    const errorRate      = new Rate('json_error_rate');

    const JAVA_MSG_URL   = __ENV.JAVA_MSG_URL   || 'http://java-mirth.mirth-infra.svc.cluster.local';
    const NODEJS_MSG_URL = __ENV.NODEJS_MSG_URL || 'http://node-mirth.mirth-benchmark.svc.cluster.local';

    // Sample Patient JSON payload
    const PATIENT_JSON = JSON.stringify({
      id: 'P-12345',
      name: { given: 'John', family: 'Doe', middle: 'Q' },
      birthDate: '1980-01-15',
      gender: 'male',
      address: {
        line: ['123 Main St', 'Apt 4B'],
        city: 'Anytown',
        state: 'CA',
        postalCode: '90210',
        country: 'US',
      },
      telecom: [
        { system: 'phone', value: '555-0100' },
        { system: 'email', value: 'john.doe@example.com' },
      ],
      identifier: [
        { system: 'MRN', value: '12345' },
        { system: 'SSN', value: '999-99-9999' },
      ],
    });

    export const options = {
      summaryTrendStats: ['avg', 'min', 'med', 'max', 'p(90)', 'p(95)', 'p(99)'],
      scenarios: {
        java_json: {
          executor: 'ramping-vus',
          startVUs: 0,
          stages: [
            { duration: '20s', target: 3 },
            { duration: '60s', target: 10 },
            { duration: '10s', target: 0 },
          ],
          startTime: '0s',
          tags: { engine: 'java' },
          env: { TARGET_URL: `${JAVA_MSG_URL}:7091`, ENGINE: 'java' },
        },
        nodejs_json: {
          executor: 'ramping-vus',
          startVUs: 0,
          stages: [
            { duration: '20s', target: 3 },
            { duration: '60s', target: 10 },
            { duration: '10s', target: 0 },
          ],
          startTime: '100s',
          tags: { engine: 'nodejs' },
          env: { TARGET_URL: `${NODEJS_MSG_URL}:7081`, ENGINE: 'nodejs' },
        },
      },
      thresholds: {
        'json_latency{engine:nodejs}':  ['p(95)<500'],
        'json_latency{engine:java}':    ['p(95)<1000'],
        'json_processed{engine:nodejs}': ['count>=0'],
        'json_processed{engine:java}':   ['count>=0'],
        'json_error_rate{engine:nodejs}': ['rate<0.1'],
        'json_error_rate{engine:java}':   ['rate<0.1'],
        'json_error_rate':              ['rate<0.1'],
      },
    };

    export default function () {
      const targetUrl = __ENV.TARGET_URL;
      const engine    = __ENV.ENGINE;
      const tags      = { engine };

      const res = http.post(`${targetUrl}/bench-json/`, PATIENT_JSON, {
        headers: { 'Content-Type': 'application/json' },
        tags,
      });

      const ok = check(res, {
        'json accepted': (r) => r.status === 200 || r.status === 201,
      });

      jsonLatency.add(res.timings.duration, tags);
      if (ok) {
        jsonThroughput.add(1, tags);
      }
      errorRate.add(!ok, tags);

      sleep(0.1);
    }

    // Helper: safely format a metric value
    function fmt(val, decimals) {
      if (val === undefined || val === null) return 'N/A';
      return typeof val === 'number' ? val.toFixed(decimals || 0) : String(val);
    }

    export function handleSummary(data) {
      const lines = [];
      lines.push('');
      lines.push('========================================');
      lines.push('  BENCHMARK: JSON TRANSFORM THROUGHPUT');
      lines.push('========================================');
      lines.push('');
      lines.push('  Both engines running natively on ARM64.');
      lines.push('  Java: Temurin JDK 11 | Node.js: v20 Alpine');
      lines.push('');

      lines.push('  json_latency:');
      for (const eng of ['java', 'nodejs']) {
        const key = `json_latency{engine:${eng}}`;
        const vals = data.metrics[key];
        if (vals && vals.values) {
          const v = vals.values;
          lines.push(`    engine=${eng}:   p50=${fmt(v.med)}ms  p95=${fmt(v['p(95)'])}ms  p99=${fmt(v['p(99)'])}ms  avg=${fmt(v.avg)}ms`);
        } else {
          lines.push(`    engine=${eng}:   (no data)`);
        }
      }

      lines.push('');
      for (const eng of ['java', 'nodejs']) {
        const key = `json_processed{engine:${eng}}`;
        const vals = data.metrics[key];
        if (vals && vals.values) {
          lines.push(`  total_messages (${eng}): ${vals.values.count}`);
        }
      }

      lines.push('');
      for (const eng of ['java', 'nodejs']) {
        const key = `json_error_rate{engine:${eng}}`;
        const vals = data.metrics[key];
        if (vals && vals.values) {
          lines.push(`  error_rate (${eng}): ${fmt(vals.values.rate * 100, 2)}%`);
        }
      }

      lines.push('');
      lines.push('========================================');
      return { stdout: lines.join('\n') + '\n' };
    }
