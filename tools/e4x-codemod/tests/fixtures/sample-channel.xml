<?xml version="1.0" encoding="UTF-8"?>
<channel version="3.9.1">
  <id>test-channel-001</id>
  <name>ADT Receiver</name>
  <description>Test channel for E4X codemod</description>
  <enabled>true</enabled>
  <revision>5</revision>
  <sourceConnector version="3.9.1">
    <metaDataId>0</metaDataId>
    <name>Source</name>
    <properties class="com.mirth.connect.connectors.http.HttpReceiverProperties" version="3.9.1">
      <listenerConnectorProperties version="3.9.1">
        <host>0.0.0.0</host>
        <port>8090</port>
      </listenerConnectorProperties>
    </properties>
    <transformer version="3.9.1">
      <elements>
        <com.mirth.connect.plugins.javascriptstep.JavaScriptStep version="3.9.1">
          <name>E4X Transform</name>
          <sequenceNumber>0</sequenceNumber>
          <enabled>true</enabled>
          <script>// Source transformer with E4X
var msg = new XML(connectorMessage.getRawData());
var pid = msg..PID;
var mrn = pid['PID.3']['PID.3.1'].toString();
$c('patientMRN', mrn);
msg.@version = "2.5.1";</script>
        </com.mirth.connect.plugins.javascriptstep.JavaScriptStep>
      </elements>
      <inboundDataType>HL7V2</inboundDataType>
      <outboundDataType>XML</outboundDataType>
    </transformer>
    <filter version="3.9.1">
      <elements>
        <com.mirth.connect.plugins.javascriptrule.JavaScriptRule version="3.9.1">
          <name>Accept ADT</name>
          <sequenceNumber>0</sequenceNumber>
          <enabled>true</enabled>
          <operator>NONE</operator>
          <script>// Filter with E4X
var msg = new XML(connectorMessage.getRawData());
var msgType = msg..MSH['MSH.9']['MSH.9.1'].toString();
return msgType === 'ADT';</script>
        </com.mirth.connect.plugins.javascriptrule.JavaScriptRule>
      </elements>
    </filter>
  </sourceConnector>
  <destinationConnectors>
    <connector version="3.9.1">
      <metaDataId>1</metaDataId>
      <name>HTTP Sender</name>
      <properties class="com.mirth.connect.connectors.http.HttpDispatcherProperties" version="3.9.1">
        <host>http://example.com/api</host>
        <method>POST</method>
      </properties>
      <transformer version="3.9.1">
        <elements>
          <com.mirth.connect.plugins.javascriptstep.JavaScriptStep version="3.9.1">
            <name>Build JSON</name>
            <sequenceNumber>0</sequenceNumber>
            <enabled>true</enabled>
            <script>// Destination transformer - no E4X
var data = JSON.parse(msg);
data.processed = true;
msg = JSON.stringify(data);</script>
          </com.mirth.connect.plugins.javascriptstep.JavaScriptStep>
        </elements>
        <inboundDataType>XML</inboundDataType>
        <outboundDataType>RAW</outboundDataType>
      </transformer>
      <responseTransformer version="3.9.1">
        <elements>
          <com.mirth.connect.plugins.javascriptstep.JavaScriptStep version="3.9.1">
            <name>Parse Response</name>
            <sequenceNumber>0</sequenceNumber>
            <enabled>true</enabled>
            <script>// Response transformer with E4X
var resp = new XML(response.getMessage());
var status = resp..Status.toString();
$c('responseStatus', status);</script>
          </com.mirth.connect.plugins.javascriptstep.JavaScriptStep>
        </elements>
      </responseTransformer>
    </connector>
  </destinationConnectors>
  <preprocessingScript>// Preprocess - no E4X
return message;</preprocessingScript>
  <postprocessingScript>// Postprocess with E4X
var msg = new XML($('rawData'));
var ackCode = msg..MSA['MSA.1'].toString();
return;</postprocessingScript>
  <deployScript>// Deploy script
return;</deployScript>
  <undeployScript>// Undeploy script
return;</undeployScript>
</channel>
