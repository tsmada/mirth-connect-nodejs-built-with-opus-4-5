<?xml version="1.0" encoding="UTF-8"?>
<codeTemplateLibrary version="3.9.1">
  <id>ks-lib-0003-0003-0003-000000000003</id>
  <name>KS Data Utils</name>
  <revision>1</revision>
  <lastModified>
    <time>1707141600000</time>
    <timezone>America/New_York</timezone>
  </lastModified>
  <description>Data utility functions for Kitchen Sink channels</description>
  <includeNewChannels>true</includeNewChannels>
  <enabledChannelIds/>
  <disabledChannelIds/>
  <codeTemplates>
    <codeTemplate version="3.9.1">
      <id>ks-tmpl-data-0001-0001-000000000001</id>
      <name>hl7ToJson</name>
      <revision>1</revision>
      <lastModified>
        <time>1707141600000</time>
        <timezone>America/New_York</timezone>
      </lastModified>
      <contextSet>
        <delegate>
          <contextType>GLOBAL_DEPLOY</contextType>
          <contextType>GLOBAL_UNDEPLOY</contextType>
          <contextType>GLOBAL_PREPROCESSOR</contextType>
          <contextType>GLOBAL_POSTPROCESSOR</contextType>
          <contextType>CHANNEL_DEPLOY</contextType>
          <contextType>CHANNEL_UNDEPLOY</contextType>
          <contextType>CHANNEL_PREPROCESSOR</contextType>
          <contextType>CHANNEL_POSTPROCESSOR</contextType>
          <contextType>CHANNEL_ATTACHMENT</contextType>
          <contextType>CHANNEL_BATCH</contextType>
          <contextType>SOURCE_RECEIVER</contextType>
          <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
          <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
          <contextType>DESTINATION_DISPATCHER</contextType>
          <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
        </delegate>
      </contextSet>
      <properties class="com.mirth.connect.model.codetemplates.BasicCodeTemplateProperties">
        <type>FUNCTION</type>
        <code>/**
 * Convert HL7 XML to a simple JSON structure.
 * @param {XML} msgXml - The HL7 XML message
 * @return {string} JSON string representation
 */
function hl7ToJson(msgXml) {
    var result = {};
    result.messageType = msgXml['MSH']['MSH.9']['MSH.9.1'].toString();
    result.messageId = msgXml['MSH']['MSH.10'].toString();
    result.patientId = msgXml['PID']['PID.3'][0]['PID.3.1'].toString();
    result.patientName = msgXml['PID']['PID.5'][0]['PID.5.1'].toString() + ', ' + msgXml['PID']['PID.5'][0]['PID.5.2'].toString();
    return JSON.stringify(result);
}</code>
      </properties>
    </codeTemplate>
    <codeTemplate version="3.9.1">
      <id>ks-tmpl-data-0002-0002-000000000002</id>
      <name>formatHL7Date</name>
      <revision>1</revision>
      <lastModified>
        <time>1707141600000</time>
        <timezone>America/New_York</timezone>
      </lastModified>
      <contextSet>
        <delegate>
          <contextType>GLOBAL_DEPLOY</contextType>
          <contextType>GLOBAL_UNDEPLOY</contextType>
          <contextType>GLOBAL_PREPROCESSOR</contextType>
          <contextType>GLOBAL_POSTPROCESSOR</contextType>
          <contextType>CHANNEL_DEPLOY</contextType>
          <contextType>CHANNEL_UNDEPLOY</contextType>
          <contextType>CHANNEL_PREPROCESSOR</contextType>
          <contextType>CHANNEL_POSTPROCESSOR</contextType>
          <contextType>CHANNEL_ATTACHMENT</contextType>
          <contextType>CHANNEL_BATCH</contextType>
          <contextType>SOURCE_RECEIVER</contextType>
          <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
          <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
          <contextType>DESTINATION_DISPATCHER</contextType>
          <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
        </delegate>
      </contextSet>
      <properties class="com.mirth.connect.model.codetemplates.BasicCodeTemplateProperties">
        <type>FUNCTION</type>
        <code>/**
 * Format an HL7 date string to ISO format.
 * @param {string} dateStr - HL7 date (yyyyMMddHHmmss)
 * @return {string} Formatted date or original if parsing fails
 */
function formatHL7Date(dateStr) {
    if (!dateStr || dateStr.length &lt; 8) return dateStr || '';
    var y = dateStr.substring(0, 4);
    var m = dateStr.substring(4, 6);
    var d = dateStr.substring(6, 8);
    return y + '-' + m + '-' + d;
}</code>
      </properties>
    </codeTemplate>
    <codeTemplate version="3.9.1">
      <id>ks-tmpl-data-0003-0003-000000000003</id>
      <name>lookupCode</name>
      <revision>1</revision>
      <lastModified>
        <time>1707141600000</time>
        <timezone>America/New_York</timezone>
      </lastModified>
      <contextSet>
        <delegate>
          <contextType>GLOBAL_DEPLOY</contextType>
          <contextType>GLOBAL_UNDEPLOY</contextType>
          <contextType>GLOBAL_PREPROCESSOR</contextType>
          <contextType>GLOBAL_POSTPROCESSOR</contextType>
          <contextType>CHANNEL_DEPLOY</contextType>
          <contextType>CHANNEL_UNDEPLOY</contextType>
          <contextType>CHANNEL_PREPROCESSOR</contextType>
          <contextType>CHANNEL_POSTPROCESSOR</contextType>
          <contextType>CHANNEL_ATTACHMENT</contextType>
          <contextType>CHANNEL_BATCH</contextType>
          <contextType>SOURCE_RECEIVER</contextType>
          <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
          <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
          <contextType>DESTINATION_DISPATCHER</contextType>
          <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
        </delegate>
      </contextSet>
      <properties class="com.mirth.connect.model.codetemplates.BasicCodeTemplateProperties">
        <type>FUNCTION</type>
        <code>/**
 * Look up a code value with global channel map caching.
 * @param {string} codeType - The category (e.g., 'LAB_CODE')
 * @param {string} code - The code to look up
 * @return {string} The code description or the code itself if not found
 */
function lookupCode(codeType, code) {
    var cacheKey = 'codeTable_' + codeType;
    var cache = $gc(cacheKey);
    if (cache) {
        return cache[code] || code;
    }
    // Cache miss â€” would normally query DB here
    // For testing, return the code itself
    return code;
}</code>
      </properties>
    </codeTemplate>
  </codeTemplates>
</codeTemplateLibrary>