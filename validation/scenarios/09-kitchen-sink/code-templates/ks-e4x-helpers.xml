<?xml version="1.0" encoding="UTF-8"?>
<codeTemplateLibrary version="3.9.1">
  <id>ks-lib-0002-0002-0002-000000000002</id>
  <name>KS E4X Helpers</name>
  <revision>1</revision>
  <lastModified>
    <time>1707141600000</time>
    <timezone>America/New_York</timezone>
  </lastModified>
  <description>E4X-heavy helper functions for Kitchen Sink E4X channels</description>
  <includeNewChannels>true</includeNewChannels>
  <enabledChannelIds/>
  <disabledChannelIds/>
  <codeTemplates>
    <codeTemplate version="3.9.1">
      <id>ks-tmpl-e4x-0001-0001-000000000001</id>
      <name>normalizePatientNameE4X</name>
      <revision>1</revision>
      <lastModified>
        <time>1707141600000</time>
        <timezone>America/New_York</timezone>
      </lastModified>
      <contextSet>
        <delegate>
          <contextType>GLOBAL_DEPLOY</contextType>
          <contextType>GLOBAL_UNDEPLOY</contextType>
          <contextType>GLOBAL_PREPROCESSOR</contextType>
          <contextType>GLOBAL_POSTPROCESSOR</contextType>
          <contextType>CHANNEL_DEPLOY</contextType>
          <contextType>CHANNEL_UNDEPLOY</contextType>
          <contextType>CHANNEL_PREPROCESSOR</contextType>
          <contextType>CHANNEL_POSTPROCESSOR</contextType>
          <contextType>CHANNEL_ATTACHMENT</contextType>
          <contextType>CHANNEL_BATCH</contextType>
          <contextType>SOURCE_RECEIVER</contextType>
          <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
          <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
          <contextType>DESTINATION_DISPATCHER</contextType>
          <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
        </delegate>
      </contextSet>
      <properties class="com.mirth.connect.model.codetemplates.BasicCodeTemplateProperties">
        <type>FUNCTION</type>
        <code>/**
 * Normalize patient name using E4X descendant + bracket access.
 * @param {XML} msgXml - The HL7 XML message (msg variable)
 * @return {string} Normalized name in LAST, FIRST SUFFIX format
 */
function normalizePatientNameE4X(msgXml) {
    var pid = msgXml..PID;
    var family = pid['PID.5'][0]['PID.5.1'].toString().toUpperCase();
    var given = pid['PID.5'][0]['PID.5.2'].toString().toUpperCase();
    var suffix = pid['PID.5'][0]['PID.5.5'].toString();
    return family + ', ' + given + (suffix ? ' ' + suffix : '');
}</code>
      </properties>
    </codeTemplate>
    <codeTemplate version="3.9.1">
      <id>ks-tmpl-e4x-0002-0002-000000000002</id>
      <name>buildAuditEntryE4X</name>
      <revision>1</revision>
      <lastModified>
        <time>1707141600000</time>
        <timezone>America/New_York</timezone>
      </lastModified>
      <contextSet>
        <delegate>
          <contextType>GLOBAL_DEPLOY</contextType>
          <contextType>GLOBAL_UNDEPLOY</contextType>
          <contextType>GLOBAL_PREPROCESSOR</contextType>
          <contextType>GLOBAL_POSTPROCESSOR</contextType>
          <contextType>CHANNEL_DEPLOY</contextType>
          <contextType>CHANNEL_UNDEPLOY</contextType>
          <contextType>CHANNEL_PREPROCESSOR</contextType>
          <contextType>CHANNEL_POSTPROCESSOR</contextType>
          <contextType>CHANNEL_ATTACHMENT</contextType>
          <contextType>CHANNEL_BATCH</contextType>
          <contextType>SOURCE_RECEIVER</contextType>
          <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
          <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
          <contextType>DESTINATION_DISPATCHER</contextType>
          <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
        </delegate>
      </contextSet>
      <properties class="com.mirth.connect.model.codetemplates.BasicCodeTemplateProperties">
        <type>FUNCTION</type>
        <code>/**
 * Build pipe-delimited audit string using E4X field access.
 * @param {XML} msgXml - The HL7 XML message (msg variable)
 * @param {string} source - Source identifier
 * @return {string} Pipe-delimited audit entry
 */
function buildAuditEntryE4X(msgXml, source) {
    var msgType = msgXml['MSH']['MSH.9']['MSH.9.1'].toString();
    var msgId = msgXml['MSH']['MSH.10'].toString();
    var patId = msgXml['PID']['PID.3'][0]['PID.3.1'].toString();
    var timestamp = msgXml['MSH']['MSH.7'].toString();
    return [source, msgType, msgId, patId, timestamp].join('|');
}</code>
      </properties>
    </codeTemplate>
    <codeTemplate version="3.9.1">
      <id>ks-tmpl-e4x-0003-0003-000000000003</id>
      <name>countSegments</name>
      <revision>1</revision>
      <lastModified>
        <time>1707141600000</time>
        <timezone>America/New_York</timezone>
      </lastModified>
      <contextSet>
        <delegate>
          <contextType>GLOBAL_DEPLOY</contextType>
          <contextType>GLOBAL_UNDEPLOY</contextType>
          <contextType>GLOBAL_PREPROCESSOR</contextType>
          <contextType>GLOBAL_POSTPROCESSOR</contextType>
          <contextType>CHANNEL_DEPLOY</contextType>
          <contextType>CHANNEL_UNDEPLOY</contextType>
          <contextType>CHANNEL_PREPROCESSOR</contextType>
          <contextType>CHANNEL_POSTPROCESSOR</contextType>
          <contextType>CHANNEL_ATTACHMENT</contextType>
          <contextType>CHANNEL_BATCH</contextType>
          <contextType>SOURCE_RECEIVER</contextType>
          <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
          <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
          <contextType>DESTINATION_DISPATCHER</contextType>
          <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
        </delegate>
      </contextSet>
      <properties class="com.mirth.connect.model.codetemplates.BasicCodeTemplateProperties">
        <type>FUNCTION</type>
        <code>/**
 * Count segments using E4X iteration.
 * @param {XML} msgXml - The HL7 XML message
 * @param {string} segName - Segment name to count
 * @return {number} Count of matching segments
 */
function countSegments(msgXml, segName) {
    var count = 0;
    for each (var seg in msgXml.children()) {
        if (seg.name().toString() === segName) count++;
    }
    return count;
}</code>
      </properties>
    </codeTemplate>
    <codeTemplate version="3.9.1">
      <id>ks-tmpl-e4x-0004-0004-000000000004</id>
      <name>extractAllOBXCodes</name>
      <revision>1</revision>
      <lastModified>
        <time>1707141600000</time>
        <timezone>America/New_York</timezone>
      </lastModified>
      <contextSet>
        <delegate>
          <contextType>GLOBAL_DEPLOY</contextType>
          <contextType>GLOBAL_UNDEPLOY</contextType>
          <contextType>GLOBAL_PREPROCESSOR</contextType>
          <contextType>GLOBAL_POSTPROCESSOR</contextType>
          <contextType>CHANNEL_DEPLOY</contextType>
          <contextType>CHANNEL_UNDEPLOY</contextType>
          <contextType>CHANNEL_PREPROCESSOR</contextType>
          <contextType>CHANNEL_POSTPROCESSOR</contextType>
          <contextType>CHANNEL_ATTACHMENT</contextType>
          <contextType>CHANNEL_BATCH</contextType>
          <contextType>SOURCE_RECEIVER</contextType>
          <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
          <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
          <contextType>DESTINATION_DISPATCHER</contextType>
          <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
        </delegate>
      </contextSet>
      <properties class="com.mirth.connect.model.codetemplates.BasicCodeTemplateProperties">
        <type>FUNCTION</type>
        <code>/**
 * Extract all OBX codes using E4X for-each.
 * @param {XML} msgXml - The HL7 XML message
 * @return {Array} Array of OBX code strings
 */
function extractAllOBXCodes(msgXml) {
    var codes = [];
    for each (var obx in msgXml..OBX) {
        codes.push(obx['OBX.3']['OBX.3.1'].toString());
    }
    return codes;
}</code>
      </properties>
    </codeTemplate>
  </codeTemplates>
</codeTemplateLibrary>